@* https://github.com/cytoscape/cytoscape.js/blob/unstable/documentation/demos/compound-nodes/index.html *@

@page "/dashboards/graph"

<h3>Model Graph</h3>


<button id="center">Center</button>
<button id="reset_zoom">Reset zoom</button>
<button id="enable_zoom">Enable zoom</button>
<button id="hide">Hide selection</button>
<div id="cy"></div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        // https://stackoverflow.com/questions/75845434/why-the-following-simple-cytoscape-dagre-html-is-not-working
        await JsDual.EvalExternalScript("https://unpkg.com/dagre@0.7.4/dist/dagre.js");
        await JsDual.EvalExternalScript("https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js");
        await JsDual.EvalExternalScript("https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js");


        // var data = await Http.GetRestResultAsync<string>($"/api/info/graph?fqdn=HelloDS.STN1.Work1");
        // var data = await Http.GetRestResultAsync<string>($"/api/info/graph?fqdn=SIDE6.S200_CARTYPE_MOVE");
        var data = await Http.GetRestResultAsync<string>($"/api/info/graph");
        await data.IterAsync(
            async json => {
                Console.WriteLine($"--------------- Cytoscape data:\r\n{json}");
                await JsDual.EvalOnGlobalModule($"window.cyData = {json};");
            },
            async err => await JsDual.Alert($"Failed to get data: {err}")
            );

        await JsDual.EvalOnGlobalModule(@"
//
// Graph algorithm 상에서 DAG 로 그리기 위해서 reset edge 는 일단 제외한 상태로 시작
//
var cyData = window.cyData
console.log(cyData)
var resetEdges = cyData.edges.filter(edge => edge.classes.includes('Reset'));
var nonResetEdges = cyData.edges.filter(edge => !edge.classes.includes('Reset'));

console.log(`Initial: resetEdges = ${resetEdges.length}, nonResetEdges = ${nonResetEdges.length}`)


// 동일한 source와 target을 가지는 엣지들을 병합합니다.
resetEdges.forEach(resetEdge => {
    let matchingEdge = nonResetEdges.find(edge => edge.data.source === resetEdge.data.target && edge.data.target === resetEdge.data.source);
    if (matchingEdge) {
        // matchingEdge의 클래스를 'Start, Reset' 으로 업데이트합니다.
        matchingEdge.classes = 'Start, ReverseReset';
    } else {
        // 만약 매칭되는 엣지가 없으면, resetEdge를 유지합니다.
        nonResetEdges.push(resetEdge);
    }
});
console.log(`Middle: resetEdges = ${resetEdges.length}, nonResetEdges = ${nonResetEdges.length}`)


cyData.edges = nonResetEdges

var cy = window.cy = cytoscape({
    container: document.getElementById('cy'),

    boxSelectionEnabled: false,

    style: [
        // https://stackoverflow.com/questions/45572034/how-to-select-nodes-by-class-in-cytoscape-js
        {
            selector: 'node',
            css: {
                // 'shape': 'data(shape)',
                'shape': 'pentagon',
                'content': 'data(content)',
                'text-valign': 'center',
                'text-halign': 'center',
                'background-opacity': 1,
            }
        },
        {
            selector: 'node.Flow',
            css: {
                'shape': 'rectangle',
                // 'text-outline-width': 1,
                // 'text-outline-color': 'white',
                'border-width': 4,
                'border-color': 'navy',
                'border-style': 'dashed',
                'font-size': '60px',
                'color': 'skyblue',
                'background-color': 'LightCyan',


                // 'text-background-color': 'blue',
                // 'text-background-padding': 100,
            }
        },
        {
            selector: 'node.Real',
            css: {
                'shape': 'rectangle',
                'background-color': 'DarkSalmon',
            }
        },
        {
            selector: 'node.Call',
            css: {
                'shape': 'ellipse',
                'background-color': 'DarkSeaGreen',
            }
        },
        {
            selector: 'node.Alias',
            css: {
                'shape': 'diamond',
            }
        },
        {
            selector: ':parent',
            css: {
                'text-valign': 'top',
                'text-halign': 'center',
                'shape': 'round-rectangle',
                'padding': 10
            }
        },
        {
            selector: ':selected',
            css: {
                'background-color': 'cyan',
            }
        },
        {
            selector: 'node#e',     // node 에서 id 가 e 인 요소
            css: {
                'padding': 0
            }
        },
        {
            selector: 'edge',
            css: {
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle',
                'target-arrow-color': 'navy',
            }
        },
        {
            selector: 'edge.Reset',
            css: {
                'line-color': 'green',
                'curve-style': 'bezier',
                'target-arrow-shape': 'circle',
                'target-arrow-color': 'red',
                'line-style': 'dashed',     // 'solid', 'dotted',
                // 'line-dash-offset': 24,
                // 'line-dash-pattern': [6, 3],
            }
        },
        {
            selector: 'edge.ReverseReset',
            css: {
                'line-color': 'green',
                'curve-style': 'bezier',
                'source-arrow-shape': 'circle',
                'source-arrow-color': 'red',
                'line-style': 'dashed',     // 'solid', 'dotted',
            }
        },
    ],


    elements: cyData,
    wheelSensitivity: 0.2,

    layout: {
        // name: 'preset',
        // name: 'grid',
        // name: 'circle',
        name: 'dagre',              // https://jsfiddle.net/bababalcksheep/nyt8Lupv/
        animate: true,
        padding: 5
    },
});


// click event: node 및 edge 둘다 적용
// node 만 적용하려면 cy.on('click', 'node', evt => ...  의 형태로 작성
cy.on('click', evt => {
    if (evt.target.id)
    {
        console.log('clicked ' + evt.target.id());
        console.log(evt.target.json());
        // console.log('clicked ' + JSON.stringify(evt.target.json()));
    }
})


// button handlers
$('#center').click(() => {
    cy.fit(cy.nodes().filter(':visible'))
    // cy.center();
});
$('#hide').click(() => {
    cy.$(':selected').style('display', 'none');
    cy.fit(cy.nodes().filter(':visible'))
});

$('#reset_zoom').click(() => {
    // multi layout : https://stackoverflow.com/questions/52200858/cytoscape-js-multiple-layouts-different-layout-within-compound-nodes

    // 최상위 레벨 노드를 찾기
    var topLevelNodes = cy.nodes().filter(function(node) {
      return node.data('parent') === undefined && !node.hasClass('DsSystem');;
    });

    const disconnectedNodes = cy.nodes().filter(node => node.degree(false) === 0);
    disconnectedNodes.layout({
      name: 'grid',
      rows: 3 // 모든 단일 노드를 한 줄로 배치
    }).run();


    console.log('Top level nodes:');
    topLevelNodes.forEach(function(node) {
      console.log(node.data('id'));
    });

    // 최상위 레벨 노드에 grid layout 적용
    topLevelNodes.layout({
      name: 'grid',
      columns: 3,
      fit: true,
      padding: 30,
    }).run();

    // topLevelNodes[0].descendants().layout({
    //   name: 'dagre',
    //   // columns: 3,
    //   // fit: true,
    //   padding: 30,
    // }).run();

    cy.$('node.Flow').layout({
      name: 'dagre',
      // columns: 3,
      // fit: true,
      padding: 30,
    }).run();


    // console.log('resetting..');
    // cy.$('#HelloDS.STN1.Work1.STN1__Device1_RET')
    //     .data('shape', 'rectangle')
    //     .addClass('active');
});

");
    }

}

<style>
    body {
        font: 14px helvetica neue, helvetica, arial, sans-serif;
    }

    #cy {
        height: 90%;
        width: 90%;
        position: relative;
        left: 0;
        top: 0;
    }
 </style>
 
      
@*
cy.nodes()
cy.edges()
cy.$(':selected')
cy.$(':visible')
cy.$(':hidden')
cy.$(':parent')
cy.$('node.Flow')
cy.$(':selected').position()
cy.$(':selected').position({x:2000, y:10})
cy.$('#SIDE.S200_CARTYPE_MOVE.S204_END__SIDE.S200_CARTYPE_MOVE.S205_RBT1')
cy.$id('SIDE.S200_CARTYPE_MOVE.S204_END__SIDE.S200_CARTYPE_MOVE.S205_RBT1') // cy.$('#some-id') 와 동일
cy.$id('SIDE.S200_CARTYPE_MOVE.S204_END__SIDE.S200_CARTYPE_MOVE.S205_RBT1').data()
cy.$id('SIDE.S200_CARTYPE_MOVE.S204_END__SIDE.S200_CARTYPE_MOVE.S205_RBT1').classes()
cy.edges().filter(e => e.classes().includes("Reset")).length
cy.edges().filter(e => e.classes().includes("Reset"))[0].data()
cy.edges().filter(e => e.classes().includes("Reset"))[0].classes()
cy.edges().filter(e => e.classes().includes("Reset")).json()

cy.edges().filter(e => e.data().source === 'SIDE.MES.S201_RBT1' ).json()
*@



@* 

     // elements: {
     //   nodes: [
     //     { data: { id: 'a', parent: 'b' }, position: { x: 215, y: 85 } },
     //     { data: { id: 'b' } },
     //     { data: { id: 'c', parent: 'b' }, position: { x: 300, y: 85 } },
     //     { data: { id: 'd' }, position: { x: 215, y: 175 } },
     //     { data: { id: 'e' } },
     //     { data: { id: 'f', parent: 'e' }, position: { x: 300, y: 175 } }
     //   ],
     //   edges: [
     //     { data: { id: 'ad', source: 'a', target: 'd' } },
     //     { data: { id: 'eb', source: 'e', target: 'b' } }
   
     //   ]
     // },
   
   
   // elements: {
   //     'nodes': [
   //         { data: { id: 'a', parent: 'p' } },
   //         { data: { id: 'b', parent: 'p' } },
   //         { data: { id: 'c', parent: 'p' } },
   //         { data: { id: 'd', parent: 'p' } },
   //         { data: { id: 'e', parent: 'p' } },
   //         { data: { id: 'f', parent: 'p' } },
   //         { data: { id: 'g', parent: 'p' } },
   //         { data: { id: 'h', parent: 'p' } },
   //         { data: { id: 'p' } }
   //     ],
   //     'edges': [
   //         { data: { id: 'e1', source: 'a', target: 'b' } },
   //         { data: { id: 'e2', source: 'b', target: 'c' } },
   //         { data: { id: 'e3', source: 'b', target: 'd' } },
   //         { data: { id: 'e4', source: 'e', target: 'f' } },
   //         { data: { id: 'e5', source: 'f', target: 'g' } },
   //         { data: { id: 'e6', source: 'f', target: 'h' } }
   //     ]
   // },
   
   
   // elements: {
   //     nodes: [
   //         { data: { id: 'a', parent: 'p' }, position: { x: 215, y: 85 } },
   //         { data: { id: 'b', parent: 'p' }, position: { x: 300, y: 85 } },
   //         { data: { id: 'p' } }
   //     ],
   //     edges: [
   //         { data: { id: 'e1', source: 'a', target: 'b' } }
   //     ]
   // },
   
   
   
   // // https://stackoverflow.com/questions/27280708/how-do-i-make-classes-work-in-cytoscape-js
   // var cy = cytoscape({
   //     container: document.getElementById('cy'),
   //     style: [
   //         {
   //             selector: 'node',
   //             style: {
   //                 'label': 'data(id)'
   //             }
   //         },

   //         {
   //             selector: '.ClassName1',
   //             style: {
   //                 'width': 8,
   //                 'height': 8,
   //                 'label': ''
   //             }
   //         }
   //     ],
   //     elements: {
   //         nodes: [
   //               { data: { id: 'explore'}, classes: 'ClassName1'},
   //               { data: { id: 'discover' } }
   //         ],
   //         edges: [
   //               { data: { source: 'explore', target: 'discover' } }
   //         ]
   //    },
   // });
   
   
Shapes: 
   ellipse
   triangle
   round-triangle
   rectangle
   round-rectangle
   bottom-round-rectangle
   cut-rectangle
   barrel
   rhomboid
   right-rhomboid
   diamond
   round-diamond
   pentagon
   round-pentagon
   hexagon
   round-hexagon
   concave-hexagon
   heptagon
   round-heptagon
   octagon
   round-octagon
   star
   tag
   round-tag
   vee
   polygon (custom polygon specified via shape-polygon-points).

*@