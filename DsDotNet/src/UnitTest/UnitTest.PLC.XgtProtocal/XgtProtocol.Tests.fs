namespace XgtProtocol.Tests

open System
open Xunit
open System.Collections.Generic
open XgtProtocol.Batch
open XgtProtocol
open System.Threading
open Dual.PLC.Common.FS

module XgtTagTests =
    
    //[<Fact>]   
    //let ``XGTTag UpdateValue should detect change for UInt16`` () =
    //    let tag = XGTTag("%MW00010", true, false)
    //    tag.LWordOffset <- 20 // StartByteOffset = 160
    //    let buf = Array.zeroCreate<byte> 256
    //    BitConverter.GetBytes(123us).CopyTo(buf, tag.StartByteOffset)
    //    let changed = tag.UpdateValue(buf)
    //    Assert.True(changed)
    //    Assert.Equal(box 123us, tag.Value)

    //[<Fact>]
    //let ``XGTTag UpdateValue should return false for no change`` () =
    //    let tag = XGTTag("%MW00010", true, false)
    //    tag.LWordOffset <- 20
    //    let buf = Array.zeroCreate<byte> 256
    //    BitConverter.GetBytes(321us).CopyTo(buf, tag.StartByteOffset)
    //    tag.UpdateValue(buf) |> ignore // 첫 번째 업데이트
    //    let changed = tag.UpdateValue(buf) // 두 번째는 변경 없어야 함
    //    Assert.False(changed)


//module BatchTests =

    [<Fact>]
    let ``prepareReadBatches groups tags by LWordOffset`` () =
        let batchCnt = 2 //최대 Lword 64 개씩
        let tags = [| for i in 0..16*batchCnt-1 -> 
                        XGTTag($"%%ML000{i}", true, false) 
                    |]
        let batches = prepareReadBatches tags
        Assert.Equal(batchCnt, batches.Length)
        let offsets = batches |> Array.map (fun b -> b.Tags[0].LWordTag)
        Assert.Equal<string[]>([|"%ML0"; "%ML16";|], offsets)



module IntegrationTests =

    let runEthernetTest (plcIp: string) (areaCodes: char list) =
        let conn = XgtEthernet(plcIp, 2004, 500)
        let tests=[
                "%QX15.13.25"
                "%QX15.13.26"
                "%QX15.13.27"
                "%QX15.13.28"
                "%QX16.3.32"
                "%QX16.3.33"
                "%QX16.3.34"
                "%QX16.3.35"
                "%QX16.3.36"
                "%QX16.3.37"
                "%QX16.3.38"
                "%QX16.3.39"
                "%QX16.3.44"
                "%QX16.3.45"
                "%QX16.3.46"
                "%QX16.3.47"
                "%QX16.4.16"
                "%QX16.4.17"
                "%QX16.4.18"
                "%QX16.4.19"
                "%QX16.4.20"
                "%QX16.4.21"
                "%QX16.4.28"
                "%QX16.9.57"
                "%QX16.9.58"
                "%QX16.9.59"
                "%QX16.9.60"
                "%QX16.9.61"
                "%QX16.9.62"
                "%QX17.1.0"
                "%QX17.1.1"
                "%QX17.1.2"
                "%QX17.1.3"
                "%QX17.1.12"
                "%QX62.10.48"
                "%QX62.10.49"
                "%QX62.10.50"
                "%QX62.10.51"
                "%QX62.10.52"
                "%QX62.10.53"
                "%QW16.4.1"
                "%QW17.1.0"
                "%QX16.2.0"
                "%QX16.2.1"
                "%QX16.2.2"
                "%QX16.14.32"
                "%QX17.13.16"
                "%QX17.13.17"
                "%QX17.13.18"
                "%QX17.13.19"
                "%QX17.13.20"
                "%QX17.13.21"
                "%QX18.2.61"
                "%QX18.2.62"
                "%QX18.2.63"
                "%QX18.3.16"
                "%QX18.3.17"
                "%QX18.3.18"
                "%QX18.3.19"
                "%QX18.9.14"
                "%QX18.9.15"
                "%QX18.10.0"
                "%QX18.10.1"
                "%QX18.10.2"
                "%QX18.10.3"
                "%QX18.10.4"
                "%QX18.10.5"
                "%QX18.10.12"
                "%QX18.15.29"
                "%QX18.15.30"
                "%QX18.15.31"
                "%QX19.5.46"
                "%QX19.5.47"
                "%QX19.11.61"
                "%QX19.11.62"
                "%QX19.11.63"
                "%QX20.2.14"
                "%QX20.2.15"
                "%QX20.2.48"
                "%QX20.2.49"
                "%QX20.2.50"
                "%QX20.2.51"
                "%QX20.2.52"
                "%QX20.2.53"
                "%QX62.13.16"
                "%QX62.13.17"
                "%QX62.13.18"
                "%QX62.13.19"
                "%QX62.15.32"
                "%QX62.15.33"
                "%QX62.15.34"
                "%QX62.15.35"
                "%QX62.15.36"
                "%QX62.15.37"
                "%QX62.15.38"
                "%QX62.15.39"
                "%QX62.15.40"
                "%QX62.15.41"
                "%QX62.15.42"
                "%QX62.15.43"
                "%QX62.15.44"
                "%QX62.15.45"
                "%QX62.15.46"
                "%QX62.15.47"
                "%QX62.15.48"
                "%QX62.15.49"
                "%QX62.15.50"
                "%QX62.15.51"
                "%QX63.0.0"
                "%QX63.0.1"
                "%QX63.0.2"
                "%QX63.0.3"
                "%QX63.0.4"
                "%QX63.0.5"
                "%QX63.0.6"
                "%QX63.0.7"
                "%QX63.0.8"
                "%QX63.0.9"
                "%QX63.0.10"
                "%QX63.0.11"
                "%QX63.0.12"
                "%QX63.0.13"
                "%QX63.0.14"
                "%QX63.0.15"
                "%QX63.0.16"
                "%QX63.0.17"
                "%QX63.0.18"
                "%QX63.0.19"
                "%QX63.3.0"
                "%QX63.3.1"
                "%QX63.3.2"
                "%QX63.3.3"
                "%QX63.3.4"
                "%QX63.3.5"
                "%QX63.3.6"
                "%QX63.3.7"
                "%QX63.3.8"
                "%QX63.3.9"
                "%QX63.3.10"
                "%QX63.3.11"
                "%QX63.3.12"
                "%QX63.3.13"
                "%QX63.3.14"
                "%QX63.3.15"
                "%QX63.5.32"
                "%QX63.5.33"
                "%QX63.5.34"
                "%QX63.5.35"
                "%QX63.5.36"
                "%QX63.5.37"
                "%QX63.5.38"
                "%QX63.5.39"
                "%QX63.5.40"
                "%QX63.5.41"
                "%QX63.5.42"
                "%QX63.5.43"
                "%QX63.5.44"
                "%QX63.5.45"
                "%QX63.5.46"
                "%QX63.5.47"
                "%QW17.13.1"
                "%QW17.13.2"
                "%QW18.3.1"
                "%QW18.10.0"
                "%QX17.11.0"
                "%QX17.11.1"
                "%QX17.11.3"
                "%QX18.7.32"
                "%QX18.7.33"
                "%QX18.7.34"
                "%QX20.0.32"
                "%QX20.8.28"
                "%QX20.8.29"
                "%QX20.8.30"
                "%QX20.8.31"
                "%QX20.8.48"
                "%QX20.8.49"
                "%QX20.8.50"
                "%QX20.8.51"
                "%QX20.14.46"
                "%QX20.14.47"
                "%QX21.4.60"
                "%QX21.4.61"
                "%QX21.4.62"
                "%QX21.4.63"
                "%QX21.5.16"
                "%QX21.5.17"
                "%QX21.5.18"
                "%QX21.5.19"
                "%QX21.11.14"
                "%QX21.11.15"
                "%QX63.7.32"
                "%QX63.7.33"
                "%QX63.7.34"
                "%QX63.7.35"
                "%QX63.7.36"
                "%QX63.7.37"
                "%QX63.7.38"
                "%QX63.7.39"
                "%QX63.7.40"
                "%QX63.7.41"
                "%QX63.7.42"
                "%QX63.7.43"
                "%QX63.7.44"
                "%QX63.7.45"
                "%QX63.7.46"
                "%QX63.7.47"
                "%QX63.10.0"
                "%QX63.10.1"
                "%QX63.10.2"
                "%QX63.10.3"
                "%QX63.10.4"
                "%QX63.10.5"
                "%QX63.10.6"
                "%QX63.10.7"
                "%QX63.10.8"
                "%QX63.10.9"
                "%QX63.10.10"
                "%QX63.10.11"
                "%QX63.10.12"
                "%QX63.10.13"
                "%QX63.10.16"
                "%QX63.10.17"
                "%QX63.10.18"
                "%QX63.10.19"
                "%QX63.10.20"
                "%QX63.10.21"
                "%QX63.10.22"
                "%QX63.10.23"
                "%QX63.10.24"
                "%QX63.10.25"
                "%QX63.10.26"
                "%QX63.10.27"
                "%QX63.10.28"
                "%QX63.10.29"
                "%QW20.8.3"
                "%QW21.5.1"
                "%QX21.9.32"
                "%QX31.14.16"
                "%QX31.14.17"
                "%QX32.10.48"
                "%QX32.10.49"
                "%QX33.0.29"
                "%QX33.0.30"
                "%QX33.0.31"
                "%QX33.6.46"
                "%QX33.6.47"
                "%QX33.12.61"
                "%QX33.12.62"
                "%QX33.12.63"
                "%QX34.3.14"
                "%QX34.3.15"
                "%QX63.12.32"
                "%QX63.12.33"
                "%QX63.12.34"
                "%QX63.12.35"
                "%QX63.12.36"
                "%QX63.12.37"
                "%QX63.12.38"
                "%QX63.12.39"
                "%QX63.12.40"
                "%QX63.12.41"
                "%QX63.12.42"
                "%QX63.12.43"
                "%QX63.12.44"
                "%QX63.12.45"
                "%QX63.12.46"
                "%QX63.12.47"
                "%QX63.13.32"
                "%QX63.13.33"
                "%QX63.13.34"
                "%QX63.13.35"
                "%QX63.13.36"
                "%QX63.13.37"
                "%QX63.13.38"
                "%QX63.13.39"
                "%QX63.13.40"
                "%QX63.13.41"
                "%QX63.13.42"
                "%QX63.13.43"
                "%QX63.13.48"
                "%QX63.13.49"
                "%QX63.13.50"
                "%QX63.13.51"
                "%QX63.13.52"
                "%QX63.13.53"
                "%QX63.13.54"
                "%QX63.13.55"
                "%QX63.13.56"
                "%QX63.13.57"
                "%QX63.15.0"
                "%QX63.15.1"
                "%QX63.15.2"
                "%QX63.15.3"
                "%QX63.15.4"
                "%QX63.15.5"
                "%QX63.15.6"
                "%QX63.15.7"
                "%QX63.15.8"
                "%QX63.15.9"
                "%QX63.15.10"
                "%QX63.15.11"
                "%QX63.15.16"
                "%QX63.15.17"
                "%QX63.15.18"
                "%QX63.15.19"
                "%QX63.15.20"
                "%QX63.15.21"
                "%QX63.15.22"
                "%QX63.15.23"
                "%QX63.15.24"
                "%QX63.15.25"
                "%QX31.12.0"
                "%QX31.12.1"
                "%QX31.12.2"
                "%QX31.12.3"
                "%QX32.8.32"
                "%QX32.8.33"
                "%QX32.8.34"
                "%QX32.8.35"
                "%QX33.5.0"
                "%QX22.1.48"
                "%QX22.1.49"
                "%QX22.1.59"
                "%QX22.1.60"
                "%QX22.7.32"
                "%QX22.7.33"
                "%QX22.7.34"
                "%QX22.7.35"
                "%QX22.7.36"
                "%QX22.7.37"
                "%QX22.7.38"
                "%QX22.7.39"
                "%QX22.7.44"
                "%QX22.8.32"
                "%QX22.8.33"
                "%QX22.8.34"
                "%QX22.8.35"
                "%QX22.8.44"
                "%QX22.14.16"
                "%QX22.14.17"
                "%QX22.14.27"
                "%QX22.14.28"
                "%QX23.4.0"
                "%QX23.4.1"
                "%QX23.4.2"
                "%QX23.4.3"
                "%QX23.4.4"
                "%QX23.4.5"
                "%QX23.4.6"
                "%QX23.4.7"
                "%QX23.4.12"
                "%QX23.5.0"
                "%QX23.5.1"
                "%QX23.5.2"
                "%QX23.5.3"
                "%QX23.5.12"
                "%QX23.10.28"
                "%QX23.10.29"
                "%QX23.10.30"
                "%QX23.10.31"
                "%QX24.0.46"
                "%QX24.0.47"
                "%QX24.6.61"
                "%QX24.6.62"
                "%QX24.6.63"
                "%QX24.13.14"
                "%QX24.13.15"
                "%QX64.1.48"
                "%QX64.1.49"
                "%QX64.1.50"
                "%QX64.1.51"
                "%QX64.1.52"
                "%QX64.1.53"
                "%QX64.1.54"
                "%QX64.1.55"
                "%QX64.1.56"
                "%QX64.1.57"
                "%QX64.1.58"
                "%QX64.1.59"
                "%QX64.2.32"
                "%QX64.2.33"
                "%QX64.2.34"
                "%QX64.2.35"
                "%QX64.2.36"
                "%QX64.2.37"
                "%QX64.2.38"
                "%QX64.2.39"
                "%QX64.2.40"
                "%QX64.2.41"
                "%QX64.2.42"
                "%QX64.2.43"
                "%QX64.2.44"
                "%QX64.2.45"
                "%QX64.2.46"
                "%QX64.2.47"
                "%QX64.2.48"
                "%QX64.2.49"
                "%QX64.2.50"
                "%QX64.2.51"
                "%QX64.4.16"
                "%QX64.4.17"
                "%QX64.4.18"
                "%QX64.4.19"
                "%QX64.4.20"
                "%QX64.4.21"
                "%QX64.4.22"
                "%QX64.4.23"
                "%QX64.4.24"
                "%QX64.4.25"
                "%QX64.4.26"
                "%QX64.4.27"
                "%QX64.5.0"
                "%QX64.5.1"
                "%QX64.5.2"
                "%QX64.5.3"
                "%QX64.5.4"
                "%QX64.5.5"
                "%QX64.5.6"
                "%QX64.5.7"
                "%QX64.5.8"
                "%QX64.5.9"
                "%QX64.5.10"
                "%QX64.5.11"
                "%QX64.5.12"
                "%QX64.5.13"
                "%QX64.5.14"
                "%QX64.5.15"
                "%QX64.5.16"
                "%QX64.5.17"
                "%QX64.5.18"
                "%QX64.5.19"
                "%QX64.6.48"
                "%QX64.6.49"
                "%QX64.6.50"
                "%QX64.6.51"
                "%QX64.6.52"
                "%QX64.6.53"
                "%QX64.6.54"
                "%QX64.6.56"
                "%QX64.6.57"
                "%QX64.6.58"
                "%QX64.6.59"
                "%QX64.6.60"
                "%QX64.6.61"
                "%QX64.7.0"
                "%QX64.7.1"
                "%QX64.7.2"
                "%QX64.7.3"
                "%QX64.7.6"
                "%QX64.7.7"
                "%QX64.7.8"
                "%QX64.7.9"
                "%QX64.9.16"
                "%QX64.9.17"
                "%QX64.9.18"
                "%QX64.9.19"
                "%QX64.9.20"
                "%QX64.9.21"
                "%QX64.9.22"
                "%QX64.9.24"
                "%QX64.9.25"
                "%QX64.9.26"
                "%QX64.9.27"
                "%QX64.9.28"
                "%QX64.9.29"
                "%QX64.9.32"
                "%QX64.9.33"
                "%QX64.9.34"
                "%QX64.9.35"
                "%QX64.9.38"
                "%QX64.9.39"
                "%QX64.9.40"
                "%QX64.9.41"
                "%QW22.8.2"
                "%QW23.5.0"
                "%QX22.6.0"
                "%QX22.6.1"
                "%QX22.6.2"
                "%QX22.6.3"
                "%QX23.2.32"
                "%QX23.2.33"
                "%QX23.2.34"
                "%QX23.2.35"
            ]

        if not (conn.Connect()) then
            printfn  $"[!] PLC 연결 실패 (테스트 스킵 처리): {plcIp}"
            // 연결 실패시 테스트를 성공으로 종료
            ()
        else 

            while true do
 
                for tag in tests do
                    let head, size, offset = tryParseXgiTag tag |> Option.get 
                    let address =  LsXgiTagParser.ParseAddressMemory(head, size, offset)
                    match size with
                    | 1 -> 
                        let data = conn.Read(address, PlcDataSizeType.FromBitSize size)
                        conn.Write(address, PlcDataSizeType.Boolean, not(Convert.ToBoolean data)) |> ignore
                    | 8 -> 
                        let data = conn.Read(address, PlcDataSizeType.FromBitSize size)
                        conn.Write(address, PlcDataSizeType.Byte, byte (Convert.ToByte data + 1uy)) |> ignore
                    | 16 ->
                        let data = conn.Read(address, PlcDataSizeType.FromBitSize size)
                        conn.Write(address, PlcDataSizeType.UInt16, uint16 (Convert.ToUInt16 data + 1us)) |> ignore
                    | 32 ->
                        let data = conn.Read(address, PlcDataSizeType.FromBitSize size)
                        conn.Write(address, PlcDataSizeType.UInt32, uint32 (Convert.ToUInt32 data + 1u)) |> ignore
                    | 64 ->
                        let data = conn.Read(address, PlcDataSizeType.FromBitSize size)
                        conn.Write(address, PlcDataSizeType.UInt64, uint64 (Convert.ToUInt64 data + 1UL)) |> ignore
                    | _ -> failwithf $"지원하지 않는 데이터 타입: {size}"
              
            //let rnd = Random()
            //let start = DateTime.Now
            //let areaTypes = [ 'X'; 'B'; 'W'; 'D'; 'L' ]  // 디바이스 타입

            //for code in areaCodes do
            //    for kind in areaTypes do
            //        let address = 
            //            if code = 'S' then  $"%%{code}{kind}0"  // S 디바이스는 1200 bit max
            //            else $"%%{code}{kind}256"  // 예: %%MX10, %%MW10
            //        let value, dt =
            //            match kind with
            //            | 'X' -> box true, PlcDataSizeType.Boolean
            //            | 'B' -> box (byte (rnd.Next(0, 256))), PlcDataSizeType.Byte
            //            | 'W' -> box (uint16 (rnd.Next(0, 65536))), PlcDataSizeType.UInt16
            //            | 'D' -> box (uint32 (rnd.Next(0, Int32.MaxValue))), PlcDataSizeType.UInt32
            //            | 'L' -> box (9876543210123456789UL), PlcDataSizeType.UInt64
            //            | _ -> failwith $"지원되지 않는 타입: {kind}"
                    
            //        let ok = conn.Write(address, dt, value)
            //        let read = conn.Read(address, dt)
            //        try
            //            Assert.True(ok, $"쓰기 실패 - {address}")
            //            Assert.Equal(value, read)
            //        with ex ->
            //            printfn $"[✓] {address} → {value} (읽기: {read})"
            //            printfn $"[!] 예외 - 주소: {address} → {ex.Message}"


            conn.Disconnect() |> ignore


    [<Fact>]
    let ``XGT XGK Ethernet Integration Test - Dynamic Area Write/Read for 10 seconds`` () =
        let areaCodesXGK = [ 'P'; 'M'; 'K'; 'T'; 'C'; 'U'; 'S'; 'L'; 'N'; 'D'; 'R' ]
        runEthernetTest "192.168.9.103" areaCodesXGK


    [<Fact>]
    let ``XGT XGI Ethernet Integration Test - Dynamic Area Write/Read for 10 seconds`` () =
        let areaCodesXGI = [ 'I'; (*'Q';'F';*) 'M'; 'L'; 'N'; 'K'; 'U'; 'R'; 'A'; 'W'; ]
        //let areaCodesXGI = [ 'M'; ]
        runEthernetTest "192.168.9.102" areaCodesXGI
