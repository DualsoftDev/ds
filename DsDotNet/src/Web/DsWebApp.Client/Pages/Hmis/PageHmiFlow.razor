@* PageHmiFlow *@

@page "/hmis/flow/{FlowName}"
@using DsWebApp.Client.Pages.Controllers
@inherits CompHmiLoader

<CompHmiTagManager @ref="TagManager" OnLoaded="@(() => _tagManagerLoading=false)" />

@if (_myLoading || _loading || _tagManagerLoading)
{
    <p><em>Loading...</em></p>
}
else
{
    <CompModelCpuMonitor OnModelChanged="@(_ => StateHasChanged())"
                         OnCpuRunningStatusChanged="@(_ => StateHasChanged())" />

    <h3>Flow @FlowName</h3>
    <DxLoadingPanel Visible=@(ClientGlobal.ModelDsZipPath.IsNullOrEmpty() || !ClientGlobal.IsCpuRunning)
        Text="Wait CPU running..."
        IsContentBlocked="true"
        CssClass="w-100"
        ApplyBackgroundShading="true">
        <CascadingValue Name="TagManager" Value="@TagManager">
            <CompHmiRealTable Reals="@_reals" />
            <CompHmiJobsInFlowTable System="@_system" Flow=@_flow/>
        </CascadingValue>
    </DxLoadingPanel>
}

@code {
    [Parameter] public string FlowName { get; set; }
    bool _myLoading = true;
    HMIFlow _flow;
    HMIReal[] _reals;
    HMICall[] _directCalls;
    bool _tagManagerLoading = true;
    public CompHmiTagManager TagManager { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await ClientGlobal.InitializeAsync(Http, NavigationManager, LocalStorage);
        _flow = _system.Flows.FirstOrDefault(f => f.Name == FlowName);
        _reals = _flow.Reals;
        _directCalls = _flow.DirectCalls;

        var callNames = _directCalls.Select(c => c.Name).JoinString(", ");
        Console.WriteLine($"Total {_directCalls.Length} direct calls in flow {FlowName}: {callNames}");
        _myLoading = false;
    }
}
