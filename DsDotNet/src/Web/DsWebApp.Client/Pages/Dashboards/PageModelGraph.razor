@* https://github.com/cytoscape/cytoscape.js/blob/unstable/documentation/demos/compound-nodes/index.html *@

@page "/dashboards/graph"

<h3>Model Graph</h3>


<button id="center">Center</button>
<button id="reset_zoom">Reset zoom</button>
<button id="enable_zoom">Enable zoom</button>
<button id="hide">Hide selection</button>
<div id="cy"></div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        // https://stackoverflow.com/questions/75845434/why-the-following-simple-cytoscape-dagre-html-is-not-working
        await JsDual.EvalExternalScript("https://unpkg.com/dagre@0.7.4/dist/dagre.js");
        await JsDual.EvalExternalScript("https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js");
        await JsDual.EvalExternalScript("https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js");

        /*
         * cytoscape.js 제작용 data 를 window.cyData 에 저장하고 이를 처리하기 위한 javascript 실행.  (cyDsGraph.js)
         */
        // var data = await Http.GetRestResultAsync<string>($"/api/info/graph?fqdn=HelloDS.STN1.Work1");
        // var data = await Http.GetRestResultAsync<string>($"/api/info/graph?fqdn=SIDE6.S200_CARTYPE_MOVE");
        var data = await Http.GetRestResultAsync<string>($"/api/info/graph");
        await data.IterAsync(
            async json => {
                Console.WriteLine($"--------------- Cytoscape data:\r\n{json}");
                await JsDual.EvalOnGlobalModule($"window.cyData = {json};");
            },
            async err => await JsDual.Alert($"Failed to get data: {err}")
            );

        await JsDual.EvalExternalScript("js/cyDsGraph.js");
        await JsDual.EvalOnGlobalModule(@"
// click event: node 및 edge 둘다 적용
// node 만 적용하려면 cy.on('click', 'node', evt => ...  의 형태로 작성
cy.on('click', evt => {
    if (evt.target.id) {
        console.log('clicked ' + evt.target.id());
        console.log(evt.target.json());
        // console.log('clicked ' + JSON.stringify(evt.target.json()));
    }
})


// button handlers
$('#center').click(() => {
    cy.fit(cy.nodes().filter(':visible'))
    // cy.center();
});
$('#hide').click(() => {
    cy.$(':selected').style('display', 'none');
    cy.fit(cy.nodes().filter(':visible'))
});

$('#reset_zoom').click(() => {
    // multi layout : https://stackoverflow.com/questions/52200858/cytoscape-js-multiple-layouts-different-layout-within-compound-nodes

    // 최상위 레벨 노드를 찾기
    var topLevelNodes = cy.nodes().filter(function (node) {
        return node.data('parent') === undefined && !node.hasClass('DsSystem');;
    });

    const disconnectedNodes = cy.nodes().filter(node => node.degree(false) === 0);
    disconnectedNodes.layout({
        name: 'grid',
        rows: 3 // 모든 단일 노드를 한 줄로 배치
    }).run();


    console.log('Top level nodes:');
    topLevelNodes.forEach(function (node) {
        console.log(node.data('id'));
    });

    // 최상위 레벨 노드에 grid layout 적용
    topLevelNodes.layout({
        name: 'grid',
        columns: 3,
        fit: true,
        padding: 30,
    }).run();

    // topLevelNodes[0].descendants().layout({
    //   name: 'dagre',
    //   // columns: 3,
    //   // fit: true,
    //   padding: 30,
    // }).run();

    cy.$('node.Flow').layout({
        name: 'dagre',
        // columns: 3,
        // fit: true,
        padding: 30,
    }).run();


    // console.log('resetting..');
    // cy.$('#HelloDS.STN1.Work1.STN1__Device1_RET')
    //     .data('shape', 'rectangle')
    //     .addClass('active');
});
");
    }

}

<style>
    body {
        font: 14px helvetica neue, helvetica, arial, sans-serif;
    }

    #cy {
        height: 90%;
        width: 90%;
        position: relative;
        left: 0;
        top: 0;
    }
 </style>
 
